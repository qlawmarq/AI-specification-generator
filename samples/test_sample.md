# test_sample 詳細設計書

## 1. 概要

### 1.1 文書の目的

本詳細設計書は、数値計算機能と計算履歴管理機能を提供する「test_sample」システムの詳細設計を記述することを目的とします。本ドキュメントは、開発者がシステムの実装を進める上で必要な技術的指針を提供し、品質の高いソフトウェア開発を支援します。

### 1.2 システム概要

本システムは、基本的な四則演算、べき乗、階乗といった数値計算機能に加え、実行された計算の履歴を管理する機能を提供します。単一のモジュールで構成され、各機能は明確な責務を持つクラスおよび関数として設計されており、高い凝集度と低い結合度を実現しています。

### 1.3 対象読者

- システム開発担当者
- テスト担当者
- システム保守担当者
- プロジェクトマネージャー

## 2. システム構成

### 2.1 全体アーキテクチャ

本システムは、単一のモジュールで構成されるシンプルなアーキテクチャを採用しています。主要な機能は「Calculator」クラスに集約されており、計算ロジックと履歴管理ロジックが一元的に管理されます。

```
+---------------------+
| CalculatorCore      |
| (単一モジュール)    |
|                     |
| +-----------------+ |
| | Calculator      | |
| | (主要クラス)    | |
| |                 | |
| | - 数値計算機能  | |
| |   (加算, 減算,  | |
| |    乗算, 除算,  | |
| |    べき乗, 階乗)| |
| | - 履歴管理機能  | |
| |   (記録, 取得,  | |
| |    クリア)      | |
| +-----------------+ |
+---------------------+
```

### 2.2 主要コンポーネント

本システムの主要コンポーネントは以下の通りです。

- **Calculator クラス**:
  - **役割**: 数値計算機能（四則演算、べき乗、階乗）の提供と、それらの計算履歴の管理を行います。
  - **責務**:
    - 数値計算ロジックの実行
    - 計算結果と式の履歴記録
    - 計算履歴の取得
    - 計算履歴のクリア

### 2.3 技術スタック

本システムは以下の技術スタックを基に開発されます。

- **プログラミング言語**: Python
- **型ヒント**: `typing`モジュール（`Union`など）

## 3. 詳細設計

### 3.1 モジュール設計

#### 3.1.1 CalculatorCore モジュール

- **目的**: 数値計算機能と計算履歴管理機能を提供するためのコアロジックをカプセル化します。
- **主要機能**:
  - 数値の加算、減算、乗算、除算
  - 数値のべき乗計算
  - 非負整数の階乗計算
  - 実行された計算の履歴記録
  - 現在の計算履歴の取得
  - 計算履歴の全削除
- **インターフェース**:
  本モジュールは、`Calculator`クラスを外部に公開します。外部からは`Calculator`クラスのインスタンスを生成し、そのパブリックメソッドを通じて機能を利用します。

  ```python
  class Calculator:
      def __init__(self, name: str):
          """
          Calculatorオブジェクトを初期化します。
          :param name: 計算機の名前
          """
          pass

      def add(self, num1: Union[int, float], num2: Union[int, float]) -> Union[int, float]:
          """
          二つの数値を加算し、結果を返します。計算履歴に記録します。
          """
          pass

      def subtract(self, num1: Union[int, float], num2: Union[int, float]) -> Union[int, float]:
          """
          二つの数値を減算し、結果を返します。計算履歴に記録します。
          """
          pass

      def multiply(self, num1: Union[int, float], num2: Union[int, float]) -> Union[int, float]:
          """
          二つの数値を乗算し、結果を返します。計算履歴に記録します。
          """
          pass

      def divide(self, num1: Union[int, float], num2: Union[int, float]) -> Union[int, float]:
          """
          二つの数値を割り算し、結果を返します。ゼロ除算の場合はエラーを発生させ、計算履歴に記録します。
          """
          pass

      def power(self, base: Union[int, float], exponent: Union[int, float]) -> Union[int, float]:
          """
          指定された底と指数を用いてべき乗計算を実行します。
          """
          pass

      def factorial(self, n: int) -> int:
          """
          指定された非負の整数の階乗を計算します。
          """
          pass

      def get_history(self) -> list[str]:
          """
          クラスインスタンスが保持する計算履歴の現在のスナップショット（コピー）を返却します。
          """
          pass

      def clear_history(self) -> None:
          """
          オブジェクトの内部状態として保持されている計算履歴データを全て削除し、履歴を空の状態に戻します。
          """
          pass
  ```

- **内部構造**:
  `CalculatorCore`モジュールは、主に`Calculator`クラスによって構成されます。

  - **Calculator クラス**:
    - **属性**:
      - `name` (str): 計算機の名前を保持します。
      - `history` (list[str]): 実行された計算の履歴を文字列形式で保持するリストです。
    - **メソッド**:
      - `__init__(self, name: str)`:
        - インスタンス初期化時に`name`を設定し、`history`リストを空で初期化します。
      - `add(self, num1, num2)`:
        - `num1`と`num2`を加算し、結果を返します。
        - `f"{num1} + {num2} = {result}"`形式で`history`に記録します。
      - `subtract(self, num1, num2)`:
        - `num1`から`num2`を減算し、結果を返します。
        - `f"{num1} - {num2} = {result}"`形式で`history`に記録します。
      - `multiply(self, num1, num2)`:
        - `num1`と`num2`を乗算し、結果を返します。
        - `f"{num1} * {num2} = {result}"`形式で`history`に記録します。
      - `divide(self, num1, num2)`:
        - `num1`を`num2`で除算し、結果を返します。
        - `num2`が 0 の場合、`ZeroDivisionError`を発生させます。
        - `f"{num1} / {num2} = {result}"`形式で`history`に記録します。
      - `power(self, base, exponent)`:
        - `base`の`exponent`乗を計算し、結果を返します。
        - `f"{base} ** {exponent} = {result}"`形式で`history`に記録します。
      - `factorial(self, n)`:
        - `n`の階乗を計算し、結果を返します。
        - `n`が負の場合や浮動小数点数の場合はエラーを発生させるか、適切に処理します（今回は非負整数を前提）。
        - `f"{n}! = {result}"`形式で`history`に記録します。
      - `get_history(self)`:
        - `self.history`のコピーを返します。これにより、外部からの履歴リストの直接的な変更を防ぎます。
      - `clear_history(self)`:
        - `self.history`の内容を全てクリアします。

### 3.2 データ設計

#### 3.2.1 データ構造

本システムで管理される主要なデータは、`Calculator`クラスのインスタンスが保持する計算履歴です。

- **計算履歴 (`history`)**:
  - **型**: Python のリスト (`list`)
  - **要素の型**: 文字列 (`str`)
  - **内容**: 各計算操作の式と結果を表現する文字列（例: `"10 + 5 = 15"`, `"20 / 0 = Error: Division by zero"`）。
  - **構造**:
    ```python
    # history属性の例
    [
        "10 + 5 = 15",
        "20 - 7 = 13",
        "5 * 3 = 15",
        "10 / 2 = 5.0",
        "2 ** 3 = 8",
        "5! = 120",
        "20 / 0 = Error: Division by zero"
    ]
    ```

#### 3.2.2 データフロー

本システムにおける主要なデータフローは、計算履歴の生成、記録、取得、およびクリアです。

1.  **計算実行**:
    - `Calculator`インスタンスの`add`, `subtract`, `multiply`, `divide`, `power`, `factorial`メソッドが呼び出されます。
    - メソッド内で計算が実行され、結果が生成されます。
    - 計算式と結果が文字列として整形されます。
    - 整形された文字列が、インスタンスの`self.history`リストの末尾に追加されます。
2.  **履歴取得**:
    - `Calculator`インスタンスの`get_history`メソッドが呼び出されます。
    - `self.history`リストのコピーが呼び出し元に返されます。
3.  **履歴クリア**:
    - `Calculator`インスタンスの`clear_history`メソッドが呼び出されます。
    - `self.history`リストの内容が全て削除され、空の状態になります。

```
+-------------------+      +-------------------+
| 外部呼び出し元    |      | Calculatorインスタンス|
+-------------------+      +-------------------+
        |                          ^
        | (1) 計算メソッド呼び出し |
        +------------------------->| add(10, 5)
        |                          | subtract(20, 7)
        |                          | ...
        |                          |
        |                          | (2) 計算実行 & 履歴文字列生成
        |                          |
        |                          v
        |                  +-------------------+
        |                  | self.history      |
        |                  | (list[str])       |
        |                  |                   |
        |                  | (3) 履歴に追加    |
        |                  +-------------------+
        |                          ^
        | (4) get_history()呼び出し|
        +------------------------->|
        |                          | (5) historyのコピーを返す
        |<-------------------------+
        |                          |
        | (6) clear_history()呼び出し|
        +------------------------->|
        |                          | (7) historyをクリア
        |                          |
```

### 3.3 処理設計

#### 3.3.1 主要処理フロー

各計算メソッド（`add`, `subtract`, `multiply`, `divide`, `power`, `factorial`）の基本的な処理フローは以下の通りです。

1.  **引数検証**: 必要に応じて、引数の型や値の範囲を検証します（例: `factorial`の引数が非負整数であるか）。
2.  **計算実行**: 渡された引数を用いて、対応する数値計算を実行します。
3.  **履歴記録**:
    - 計算に使用されたオペランドと計算結果を基に、履歴文字列を生成します。
    - 生成された履歴文字列を`self.history`リストに追加します。
4.  **結果返却**: 計算結果を呼び出し元に返します。

#### 3.3.2 例外処理方式

本システムでは、特にゼロ除算に対する例外処理を明確に定義します。

- **ゼロ除算**:

  - `divide`メソッドにおいて、除数（第二引数）が`0`の場合、Python 標準の`ZeroDivisionError`を発生させます。
  - 履歴には、エラーが発生したことを示す文字列（例: `"20 / 0 = Error: Division by zero"`）を記録します。これにより、エラー発生時でも履歴から何が起こったかを追跡できます。

- **その他の例外**:
  - `factorial`メソッドにおいて、引数が非負整数でない場合（例: 負の数、浮動小数点数）は、`ValueError`などの適切な例外を発生させることを検討します。
  - 型ヒントに合致しない引数が渡された場合、Python の実行時エラーが発生しますが、これは開発段階で静的解析ツールやテストによって検出されるべき問題とします。

#### 3.3.3 エラーハンドリング

本システムのエラーハンドリングは、以下の原則に基づきます。

- **早期失敗 (Fail Fast)**: 予期しない状態や不正な入力が検出された場合、可能な限り早期に適切な例外を発生させ、問題を明確にします。
- **履歴への記録**: ユーザーが実行した操作の結果としてエラーが発生した場合、その事実を計算履歴に記録し、後から追跡できるようにします。これにより、ユーザーはエラーが発生した操作と、その結果を視覚的に確認できます。
- **呼び出し元への委譲**: 発生した例外は、原則として呼び出し元に伝播させ、上位層で適切なエラーメッセージの表示やログ記録などの対応を行うことを期待します。本モジュール内でのエラー回復処理は行いません。
